<!DOCTYPE html>
<html>
<head>
    <title>AR Зверь</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
        }

        #videoContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            border: 2px solid red; /* Индикатор наличия видео */
        }

        #canvasContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial;
            text-align: center;
            z-index: 1000;
            transition: opacity 0.3s;
            padding: 20px;
            background: rgba(0,0,0,0.8);
            border-radius: 10px;
        }

        #debugInfo {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: #00ff00;
            font-family: monospace;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div class="loader" id="loader">Инициализация камеры...</div>
    <div id="debugInfo"></div>
    <video id="videoContainer" autoplay playsinline muted></video>
    <div id="canvasContainer"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        (function() {
            const loader = document.getElementById('loader');
            const debugInfo = document.getElementById('debugInfo');
            let initializationStep = 0;

            // Конфигурация
            const config = {
                cameraRequestTimeout: 7000,
                retryCount: 3
            };

            // Логирование статуса
            function updateDebugInfo() {
                debugInfo.innerHTML = `
                    Шаг инициализации: ${initializationStep}<br>
                    Поддержка WebGL: ${Three ? 'Да' : 'Нет'}<br>
                    getUserMedia: ${navigator.mediaDevices ? 'Доступен' : 'Недоступен'}
                `;
            }

            // Основной процесс инициализации
            async function initializeApp() {
                try {
                    initializationStep = 1;
                    updateDebugInfo();
                    await checkPermissions();
                    
                    initializationStep = 2;
                    updateDebugInfo();
                    const stream = await getCameraStream();
                    
                    initializationStep = 3;
                    updateDebugInfo();
                    await initializeVideo(stream);
                    
                    initializationStep = 4;
                    updateDebugInfo();
                    await initialize3DScene();
                    
                    initializationStep = 5;
                    updateDebugInfo();
                    hideLoader();

                } catch (error) {
                    handleInitializationError(error);
                }
            }

            // Проверка необходимых разрешений
            async function checkPermissions() {
                if (!navigator.mediaDevices) {
                    throw new Error('Ваш браузер не поддерживает доступ к камере');
                }
            }

            // Получение потока с камеры
            async function getCameraStream(retry = 0) {
                try {
                    return await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                } catch (error) {
                    if (retry < config.retryCount) {
                        return new Promise(resolve => {
                            setTimeout(() => {
                                resolve(getCameraStream(retry + 1));
                            }, 1000);
                        });
                    }
                    throw error;
                }
            }

            // Инициализация видео элемента
            async function initializeVideo(stream) {
                const video = document.getElementById('videoContainer');
                video.srcObject = stream;
                
                return new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play()
                            .then(resolve)
                            .catch(reject);
                    };
                    video.onerror = reject;
                });
            }

            // Инициализация 3D сцены
            async function initialize3DScene() {
                return new Promise(resolve => {
                    // Здесь должна быть ваша логика Three.js
                    setTimeout(resolve, 500); // Заглушка для примера
                });
            }

            // Обработка ошибок
            function handleInitializationError(error) {
                console.error('Ошибка инициализации:', error);
                loader.innerHTML = `
                    <div style="color: #ff4444">
                        <h3>Ошибка инициализации!</h3>
                        <p>${error.message}</p>
                        <button 
                            style="margin-top: 10px; padding: 10px; background: #4CAF50; border: none; color: white;"
                            onclick="window.location.reload()"
                        >
                            Попробовать снова
                        </button>
                    </div>`;
            }

            function hideLoader() {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 300);
            }

            // Таймер для отслеживания зависаний
            setTimeout(() => {
                if (initializationStep < 3) {
                    loader.innerHTML += `
                        <div style="color: #ffd700; margin-top: 15px;">
                            Долгая инициализация:<br>
                            1. Проверьте разрешение для камеры<br>
                            2. Перезагрузите бота<br>
                            3. Обновите приложение Telegram
                        </div>`;
                }
            }, config.cameraRequestTimeout);

            // Запуск приложения
            window.addEventListener('load', initializeApp);
            updateDebugInfo();

        })();
    </script>
</body>
</html>