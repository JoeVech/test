<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR –û—Ö–æ—Ç–∞ - Telegram</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            touch-action: none;
            -webkit-touch-callout: none;
        }

        #videoContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #canvasContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .tg-ui {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 1001;
            width: 90%;
        }

        .tg-button {
            background: #3390ec;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 16px;
            margin: 8px;
            width: 200px;
            touch-action: manipulation;
            font-family: -apple-system, system-ui;
        }

        #statusPanel {
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <video id="videoContainer" autoplay playsinline muted></video>
    <div id="canvasContainer"></div>

    <div class="tg-ui">
        <button class="tg-button" id="startButton">üéØ –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫</button>
        <div id="statusPanel">–î–∏—Å—Ç–∞–Ω—Ü–∏—è: -</div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        let scene, renderer, camera, cube;
        const FIXED_CUBE_POSITION = new THREE.Vector3(0, 1.5, -5);
        let isTracking = false;
        let alphaOffset = 0;
        let betaOffset = 0;
        let gammaOffset = 0;

        async function init() {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ Telegram
                const [cameraPerm, motionPerm] = await Promise.all([
                    tg.requestPermission('camera'),
                    tg.requestPermission('accelerometer'),
                    tg.requestPermission('gyroscope')
                ]);

                if (!cameraPerm || !motionPerm) {
                    tg.showAlert('–î–ª—è —Ä–∞–±–æ—Ç—ã –Ω—É–∂–Ω—ã –≤—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è!');
                    return;
                }

                // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                document.getElementById('videoContainer').srcObject = stream;

                setupThreeJS();
                setupSensors();
                
            } catch (error) {
                tg.showAlert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        }

        function setupThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ 
                alpha: true,
                antialias: true,
                powerPreference: "low-power"
            });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvasContainer').appendChild(renderer.domElement);

            // –°–æ–∑–¥–∞–Ω–∏–µ AR –∫—É–±–∞
            const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            const material = new THREE.MeshPhongMaterial({
                color: 0x3390ec,
                emissive: 0x002255,
                specular: 0x555555
            });
            cube = new THREE.Mesh(geometry, material);
            cube.position.copy(FIXED_CUBE_POSITION);
            scene.add(cube);

            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(3, 3, 3);
            scene.add(directionalLight);
        }

        function setupSensors() {
            let isFirstReading = true;
            let lastUpdate = 0;
            
            window.addEventListener('deviceorientation', event => {
                if (!isTracking) return;
                
                const now = Date.now();
                if (now - lastUpdate < 50) return; // 20 FPS
                lastUpdate = now;

                if (isFirstReading) {
                    alphaOffset = event.alpha;
                    betaOffset = event.beta;
                    gammaOffset = event.gamma;
                    isFirstReading = false;
                    return;
                }

                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
                const alpha = event.alpha - alphaOffset;
                const beta = (event.beta - betaOffset) * 0.02;
                const gamma = (event.gamma - gammaOffset) * 0.02;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
                camera.position.x += gamma;
                camera.position.z += beta;
                camera.position.clampScalar(-10, 10);

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
                const distance = camera.position.distanceTo(FIXED_CUBE_POSITION);
                document.getElementById('statusPanel').textContent = 
                    `–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${distance.toFixed(1)}m`;

                // –ê–Ω–∏–º–∞—Ü–∏—è –∫—É–±–∞
                cube.rotation.y += 0.02;

                renderer.render(scene, camera);
            });

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π
            document.getElementById('startButton').addEventListener('click', () => {
                isTracking = !isTracking;
                document.getElementById('startButton').textContent = 
                    isTracking ? '‚è∏ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : 'üéØ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        tg.onEvent('viewportChanged', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        tg.ready();
        init();
    </script>
</body>
</html>