<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>AR –ó–≤–µ—Ä–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:,">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            touch-action: none;
        }

        #videoContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #canvasContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial;
            text-align: center;
            z-index: 1000;
        }

        #hud {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            font-family: Arial;
            z-index: 1000;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }

        .capture-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #ff4444aa;
            border: 3px solid #fff;
            cursor: pointer;
            z-index: 1000;
            backdrop-filter: blur(5px);
            transition: transform 0.1s;
        }

        .capture-btn:active {
            transform: translateX(-50%) scale(0.9);
        }

        #desktop-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            color: white;
            text-align: center;
            padding: 20px;
            z-index: 9999;
        }
    </style>

    <!-- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ Web3 -->
    <script>
        (function() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (!isMobile) {
                document.getElementById('desktop-warning').style.display = 'block';
                throw new Error('Desktop access blocked');
            }

            const disableWeb3 = () => {
                try {
                    delete window.ethereum;
                    delete window.web3;
                    Object.defineProperties(window, {
                        ethereum: { get: () => undefined },
                        web3: { get: () => undefined }
                    });
                } catch(e) { console.error('Web3 blocking error:', e); }
            };
            document.addEventListener('DOMContentLoaded', disableWeb3);
        })();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
</head>
<body>
    <div id="desktop-warning">
        <h2>üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
        <p>–ò–≥—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö!</p>
        <p>–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ Telegram –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–µ</p>
    </div>

    <div class="loader" id="loader">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR...</div>
    <video id="videoContainer" autoplay playsinline muted></video>
    <div id="canvasContainer"></div>
    
    <div id="hud">
        üêæ –ü–æ–π–º–∞–Ω–æ: <span id="score">0</span>
    </div>
    <div class="capture-btn" id="captureBtn"></div>

    <script>
        let currentAnimal = null;
        let score = 0;
        let scene, camera, renderer;
        const animals = [
            { type: 'fox', color: 0xFFA500, scale: 0.4 },
            { type: 'wolf', color: 0x808080, scale: 0.5 },
            { type: 'bear', color: 0x8B4513, scale: 0.6 }
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        function initTelegram() {
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                try {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    Telegram.WebApp.enableClosingConfirmation();
                } catch(e) {
                    console.warn('Telegram init error:', e);
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã
        async function initCamera() {
            const loader = document.getElementById('loader');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                const video = document.getElementById('videoContainer');
                video.srcObject = stream;
                video.style.transform = 'scaleX(1)';
                
                return new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
            } catch (error) {
                loader.innerHTML = `
                    <div style="color: red">
                        –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã!<br>
                        ${error.name}: ${error.message}<br>
                        –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø
                    </div>`;
                throw error;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Three.js
        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ 
                alpha: true,
                antialias: true,
                powerPreference: "high-performance"
            });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvasContainer').appendChild(renderer.domElement);

            // –û—Å–≤–µ—â–µ–Ω–∏–µ
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 2);
            scene.add(directionalLight);

            camera.position.z = 2;
            spawnRandomAnimal();
            animate();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∑–≤–µ—Ä—è
        function spawnRandomAnimal() {
            if (currentAnimal) scene.remove(currentAnimal);
            
            const animal = animals[Math.floor(Math.random() * animals.length)];
            const geometry = new THREE.SphereGeometry(animal.scale, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: animal.color,
                transparent: true,
                opacity: 0.9
            });
            
            currentAnimal = new THREE.Mesh(geometry, material);
            currentAnimal.position.set(
                (Math.random() - 0.5) * 3,
                (Math.random() - 0.5) * 2,
                -Math.random() * 4 - 1
            );
            
            scene.add(currentAnimal);
        }

        // –ú–µ—Ö–∞–Ω–∏–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞
        function captureAnimal() {
            score++;
            document.getElementById('score').textContent = score;
            hapticFeedback();
            spawnRandomAnimal();
            saveProgress();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π
        function initGestures() {
            const hammer = new Hammer(document.body);
            hammer.on('tap', (e) => {
                const rect = renderer.domElement.getBoundingClientRect();
                const mouse = new THREE.Vector2(
                    ((e.center.x - rect.left) / rect.width) * 2 - 1,
                    -((e.center.y - rect.top) / rect.height) * 2 + 1
                );
                
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(scene.children);
                
                if (intersects.length > 0) captureAnimal();
            });
        }

        // –¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ—Ç–¥–∞—á–∞
        function hapticFeedback() {
            try {
                if (navigator.vibrate) navigator.vibrate(50);
                if (Telegram.WebApp?.HapticFeedback) {
                    Telegram.WebApp.HapticFeedback.impactOccurred('light');
                }
            } catch(e) { console.warn('Haptic error:', e); }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function saveProgress() {
            localStorage.setItem('arGameScore', score);
            if (typeof Telegram !== 'undefined') {
                Telegram.WebApp.sendData(JSON.stringify({ score }));
            }
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è
        function animate() {
            requestAnimationFrame(animate);
            
            if (currentAnimal) {
                currentAnimal.rotation.x += 0.01;
                currentAnimal.rotation.y += 0.01;
            }
            
            renderer.render(scene, camera);
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        async function initGame() {
            try {
                initTelegram();
                await initCamera();
                document.getElementById('loader').style.display = 'none';
                initThreeJS();
                initGestures();
                
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const savedScore = localStorage.getItem('arGameScore');
                if (savedScore) {
                    score = parseInt(savedScore);
                    document.getElementById('score').textContent = score;
                }
            } catch(e) {
                console.error('Init error:', e);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // –°—Ç–∞—Ä—Ç –∏–≥—Ä—ã
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
