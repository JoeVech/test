<!DOCTYPE html>
<html>
<head>
    <title>Telegram AR Hunt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Стили остаются без изменений */
    </style>
</head>
<body>
    <!-- HTML-структура остается прежней -->
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const tg = window.Telegram.WebApp;
        let scene, camera, renderer;
        let animals = [];
        let score = 0;
        let watchId = null;

        // Конфигурация
        const config = {
            SPAWN_RADIUS: 150,
            MAX_ANIMALS: 15,
            CATCH_DISTANCE: 15,
            CAMERA_HEIGHT: 2,
            INITIAL_POSITION: new THREE.Vector3(0, 2, 5)
        };

        // Инициализация Three.js
        function initScene() {
            scene = new THREE.Scene();
            
            // Камера
            camera = new THREE.PerspectiveCamera(
                75, 
                window.innerWidth / window.innerHeight, 
                0.1, 
                1000
            );
            camera.position.copy(config.INITIAL_POSITION);
            camera.lookAt(0, 0, 0);
            
            // Рендерер
            renderer = new THREE.WebGLRenderer({ 
                alpha: true,
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            // Освещение
            const light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
            scene.add(light);
        }

        // Инициализация геолокации
        function initGeolocation() {
            if (!navigator.geolocation) {
                tg.showAlert("Geolocation is not supported");
                return;
            }

            tg.showPopup({
                title: 'Доступ к геолокации',
                message: 'Приложению нужен доступ к вашему местоположению',
                buttons: [{
                    type: 'ok',
                    id: 'geo-ok'
                }]
            });

            tg.onEvent('popupClosed', (event) => {
                if (event.button_id === 'geo-ok') {
                    startWatchingPosition();
                }
            });
        }

        // Начало отслеживания позиции
        function startWatchingPosition() {
            watchId = navigator.geolocation.watchPosition(
                position => handlePositionUpdate(position),
                error => handleGeoError(error),
                {
                    enableHighAccuracy: true,
                    maximumAge: 3000,
                    timeout: 10000
                }
            );
        }

        // Обработка обновления позиции
        function handlePositionUpdate(position) {
            const coords = position.coords;
            updateCameraPosition(coords);
            spawnAnimals(coords);
            checkCollisions(coords);
        }

        // Обновление позиции камеры
        function updateCameraPosition(coords) {
            // Преобразование координат в 3D-пространство
            camera.position.x = coords.longitude * 1000;
            camera.position.z = -coords.latitude * 1000;
            camera.lookAt(new THREE.Vector3(
                camera.position.x,
                config.CAMERA_HEIGHT,
                camera.position.z - 10
            ));
        }

        // Генерация животных
        function spawnAnimals(coords) {
            if (animals.length >= config.MAX_ANIMALS) return;

            const geometry = new THREE.SphereGeometry(0.5);
            const material = new THREE.MeshPhongMaterial({color: 0xff0000});
            
            for (let i = 0; i < 3; i++) {
                const animal = new THREE.Mesh(geometry, material);
                
                // Случайная позиция вокруг игрока
                animal.position.set(
                    camera.position.x + (Math.random() - 0.5) * config.SPAWN_RADIUS,
                    config.CAMERA_HEIGHT,
                    camera.position.z + (Math.random() - 0.5) * config.SPAWN_RADIUS
                );
                
                scene.add(animal);
                animals.push({
                    mesh: animal,
                    coords: {
                        latitude: coords.latitude + (Math.random() - 0.5) * 0.001,
                        longitude: coords.longitude + (Math.random() - 0.5) * 0.001
                    }
                });
            }
        }

        // Проверка столкновений
        function checkCollisions(coords) {
            animals = animals.filter(animal => {
                const distance = getDistance(coords, animal.coords);
                if (distance < config.CATCH_DISTANCE) {
                    scene.remove(animal.mesh);
                    score++;
                    document.getElementById('score').textContent = score;
                    tg.HapticFeedback.impactOccurred('light');
                    return false;
                }
                return true;
            });
        }

        // Расчет расстояния
        function getDistance(pos1, pos2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = pos1.latitude * Math.PI/180;
            const φ2 = pos2.latitude * Math.PI/180;
            const Δφ = (pos2.latitude - pos1.latitude) * Math.PI/180;
            const Δλ = (pos2.longitude - pos1.longitude) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // Обработка ошибок
        function handleGeoError(error) {
            let message = '';
            switch(error.code) {
                case 1: message = 'Разрешите доступ к геолокации'; break;
                case 2: message = 'Не удалось определить местоположение'; break;
                case 3: message = 'Тайм-аут запроса'; break;
            }
            tg.showPopup({title: 'Ошибка', message, buttons: [{type: 'close'}]});
        }

        // Анимация
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
            
            // Анимация животных
            animals.forEach(animal => {
                animal.mesh.rotation.y += 0.02;
                animal.mesh.position.y = 
                    config.CAMERA_HEIGHT + Math.sin(Date.now() * 0.002) * 0.5;
            });
        }

        // Инициализация
        function init() {
            tg.ready();
            tg.expand();
            initScene();
            initGeolocation();
            animate();

            // Обработка изменения размеров
            tg.onEvent('viewportChanged', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        init();
    </script>
</body>
</html>