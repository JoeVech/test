<!DOCTYPE html>
<html>
<head>
    <title>AR Звери</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <style>
        body { margin: 0; overflow: hidden; }
        #renderCanvas { width: 100%; height: 100%; touch-action: none; }
        #status {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            font-family: Arial;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
        }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <div id="status">Инициализация...</div>

    <script>
        // Конфигурация
        const DEBUG_MODE = true;
        const INITIAL_ANIMALS_COUNT = 10;

        class ARGame {
            constructor() {
                this.canvas = document.getElementById('renderCanvas');
                this.engine = null;
                this.scene = null;
                this.xr = null;
                this.init();
            }

            async init() {
                try {
                    // Инициализация движка
                    this.engine = new BABYLON.Engine(this.canvas, true, {
                        preserveDrawingBuffer: true,
                        stencil: true
                    });

                    // Проверка WebGL
                    if (!this.engine.isSupported()) {
                        this.showError('WebGL не поддерживается!');
                        return;
                    }

                    // Создание сцены
                    this.scene = await this.createScene();
                    
                    // Проверка AR
                    if (await this.checkARSupport()) {
                        await this.enableAR();
                    } else {
                        this.createFallbackScene();
                    }

                    // Старт рендеринга
                    this.engine.runRenderLoop(() => this.scene.render());

                } catch (error) {
                    this.showError(`Ошибка: ${error.message}`);
                }
            }

            async createScene() {
                const scene = new BABYLON.Scene(this.engine);
                
                // Камера
                const camera = new BABYLON.ArcRotateCamera(
                    "camera", 
                    -Math.PI/2, Math.PI/2, 10, 
                    BABYLON.Vector3.Zero(), 
                    scene
                );
                camera.attachControl(this.canvas, false);

                // Освещение
                new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(1, 1, 0), scene);
                new BABYLON.DirectionalLight("light2", new BABYLON.Vector3(0, -1, 1), scene);

                // Земля
                const ground = BABYLON.MeshBuilder.CreateGround("ground", 
                    { width: 20, height: 20 }, 
                    scene
                );
                ground.position.y = -1;

                // Спавн зверей
                this.spawnAnimals(scene);

                return scene;
            }

            spawnAnimals(scene) {
                for (let i = 0; i < INITIAL_ANIMALS_COUNT; i++) {
                    const animal = BABYLON.MeshBuilder.CreateSphere(
                        `animal_${i}`, 
                        { diameter: 0.5 }, 
                        scene
                    );
                    animal.position = new BABYLON.Vector3(
                        Math.random() * 10 - 5,
                        0.5,
                        Math.random() * 10 - 5
                    );
                    animal.material = new BABYLON.StandardMaterial("mat", scene);
                    animal.material.diffuseColor = new BABYLON.Color3(
                        Math.random(),
                        Math.random(),
                        Math.random()
                    );
                }
            }

            async checkARSupport() {
                if (!navigator.xr) return false;
                return await navigator.xr.isSessionSupported('immersive-ar');
            }

            async enableAR() {
                try {
                    this.xr = await this.scene.createDefaultXRExperienceAsync({
                        uiOptions: {
                            sessionMode: "immersive-ar",
                            referenceSpaceType: "local-floor"
                        }
                    });

                    // Обработчик ошибок AR
                    this.xr.baseExperience.sessionManager.onXRSessionInitError.add((error) => {
                        this.showError(`AR ошибка: ${error.message}`);
                        this.createFallbackScene();
                    });

                    this.updateStatus("AR режим активирован");

                } catch (error) {
                    this.showError(`AR недоступен: ${error.message}`);
                    this.createFallbackScene();
                }
            }

            createFallbackScene() {
                this.updateStatus("3D режим");
                this.scene.activeCamera.alpha += Math.PI; // Поворот камеры
            }

            showError(message) {
                this.updateStatus(`ОШИБКА: ${message}`);
                console.error(message);
            }

            updateStatus(text) {
                document.getElementById('status').textContent = text;
            }
        }

        // Запуск игры
        window.addEventListener('load', () => new ARGame());
    </script>
</body>
</html>
